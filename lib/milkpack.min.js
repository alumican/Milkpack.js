(function(){var e=[].slice,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},r=function(e,t){return function(){return e.apply(t,arguments)}};jpp.util.Scope.temp(function(){var t;return t=function(){function t(){}return t.LOGGING=!0,t.decompseFragment=function(e){var t,n,r,i,s,o,u;if(e===null||e===""||e==="/")return{route:["/"],direction:!0};r=e.split("/"),t=[],i="",n=0;for(o=0,u=r.length;o<u;o++)s=r[o],i+=i==="/"?s:"/"+s,r[n]=i,t[n]=!0,++n;return{route:r,direction:t}},t.complementFragment=function(e,n){var r,i,s,o,u,a,f;f=[],i=[],e==null&&(e=""),n==null&&(n=""),e.charAt(0)==="/"&&(e=e.substr(1)),n.charAt(0)==="/"&&(n=n.substr(1)),a=t.decompseFragment(e).route,u=t.decompseFragment(n).route,o=Math.min(a.length,u.length),r=0;while(r<o){if(a[r]!==u[r])break;++r}o=r,s=a.length-1;while(s>=o)f.push(a[s]),i.push(!1),--s;o=u.length-1,s=r;while(s<=o)f.push(u[s]),i.push(!0),++s;return{route:f,direction:i}},t.getDirection=function(e,t){var n,r,i,s,o,u;if(e===t)return 0;n=e==="/"?[""]:e.split("/"),i=t==="/"?[""]:t.split("/"),r=n.length,s=i.length,u=Math.min(r,s),o=1;while(o<u){if(n[o]!==i[o])break;++o}return r===s&&o===r-1?0:o===r&&o<s?1:-1},t.log=function(){var n;n=1<=arguments.length?e.call(arguments,0):[];if(t.LOGGING)return console.log("[Comppass] "+n.join(" "))},t.error=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],console.log("[Comppass Error] "+t.join(" "))},t.printInit=function(e,n,r){var i,s,o;if(!t.LOGGING)return;o=[];for(i in r)s=r[i],o.push("           '"+i+"'");return t.log("----------------------------------------"),t.log("Milkpack "+e.VERSION+"  © Copyright alumican.net All rights reserved."),t.log("Kazitori "+n.VERSION+"  © Copyright hageee.net All rights reserved."),t.log("root: "+n.root),t.log("routes: \n"+o.join("\n")),t.log("----------------------------------------")},t}(),jpp.util.Namespace("jpp.milkpack").register("Util",t)}),jpp.util.Scope.temp(function(){var e;return jpp.util.Namespace("jpp.event").use(),e=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.HELLO="hello",t.ARRIVE="arrive",t.STAY="stay",t.LEAVE="leave",t.BYE="bye",t.GONE="gone",t}(jpp.event.Event),jpp.util.Namespace("jpp.milkpack").register("SceneStatus",e)}),jpp.util.Scope.temp(function(){var e;return jpp.util.Namespace("jpp.event").use(),e=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.CHANGE_STATUS="chanegStatus",t}(jpp.event.Event),jpp.util.Namespace("jpp.milkpack").register("SceneEvent",e)}),jpp.util.Scope.temp(function(){var t;return jpp.util.Namespace("jpp.command").use(),jpp.util.Namespace("jpp.event").use(),jpp.util.Namespace("jpp.milkpack").use(),t=function(t){function i(e,t,n,s){this._onBye=r(this._onBye,this),this._onLeave=r(this._onLeave,this),this._onArrive=r(this._onArrive,this),this._onHello=r(this._onHello,this),this._onInit=r(this._onInit,this),this._getBye=r(this._getBye,this),this._getLeave=r(this._getLeave,this),this._getArrive=r(this._getArrive,this),this._getHello=r(this._getHello,this),this._commandCompleteHandler=r(this._commandCompleteHandler,this),i.__super__.constructor.call(this,this),this._manager=e,this._rule=t,this._fragment=n,this._params=s,this.self=this,this._title=null,this._status=jpp.milkpack.SceneStatus.GONE,this._isInitialized=!1,this._command=null,this._commandWrapper=null,this.__commandsHello=[],this.__commandsArrive=[],this.__commandsLeave=[],this.__commandsBye=[]}return n(i,t),i.self=null,i.prototype.init=function(){if(this._isInitialized)return;return this._isInitialized=!0,this._onInit()},i.prototype.hello=function(){return this._switchStatus(jpp.milkpack.SceneStatus.HELLO,this._getHello)},i.prototype.arrive=function(){return this._switchStatus(jpp.milkpack.SceneStatus.ARRIVE,this._getArrive)},i.prototype.leave=function(){return this._switchStatus(jpp.milkpack.SceneStatus.LEAVE,this._getLeave)},i.prototype.bye=function(){return this._switchStatus(jpp.milkpack.SceneStatus.BYE,this._getBye)},i.prototype.addCommand=function(){var t,n;t=1<=arguments.length?e.call(arguments,0):[];if(this._commandWrapper!==null)return(n=this._commandWrapper).addCommand.apply(n,t)},i.prototype.insertCommand=function(){var t,n;t=1<=arguments.length?e.call(arguments,0):[];if(this._commandWrapper!==null)return(n=this._commandWrapper).insertCommand.apply(n,t)},i.prototype._switchStatus=function(e,t){if(this._command!==null){jpp.milkpack.Util.log("Command is being executed (status = "+this._status+")");return}return this._clearCommand(),this._status=e,this._dispatchStatusEvent(this._status,!1),this._command=t(),this._command.addEventListener(jpp.event.Event.COMPLETE,this._commandCompleteHandler),this._command.execute()},i.prototype._clearCommand=function(){if(this._command!==null)return this._command.removeEventListener(jpp.event.Event.COMPLETE,this._commandCompleteHandler),this._command.interrupt(),this._command=null},i.prototype._commandCompleteHandler=function(e){var t;this._clearCommand(),t=this._status;switch(this._status){case jpp.milkpack.SceneStatus.ARRIVE:this._status=jpp.milkpack.SceneStatus.STAY;break;case jpp.milkpack.SceneStatus.BYE:this._status=jpp.milkpack.SceneStatus.GONE}return this._dispatchStatusEvent(t,!0)},i.prototype._dispatchStatusEvent=function(e,t){return jpp.milkpack.Util.log("Scene '"+this._fragment+"' : "+e+" "+(t?"End":"Begin")),this.dispatchEvent(jpp.milkpack.SceneEvent.CHANGE_STATUS,{status:e,isComplete:t})},i.prototype._getCommandInternal=function(e,t){return this._commandWrapper=new jpp.command.Serial,this.__commandsHello.length===0?e():this._commandWrapper.addCommandArray(t),this._commandWrapper},i.prototype.getIsInitialized=function(){return this._isInitialized},i.prototype.getManager=function(){return this._manager},i.prototype.getRule=function(){return this._rule},i.prototype.getFragment=function(){return this._fragment},i.prototype.getParams=function(){return this._params},i.prototype.getStatus=function(){return this._status},i.prototype._getHello=function(){return this._getCommandInternal(this._onHello,this.__commandsHello)},i.prototype.setHello=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this.__commandsHello=t,this},i.prototype._getArrive=function(){return this._getCommandInternal(this._onArrive,this.__commandsArrive)},i.prototype.setArrive=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this.__commandsArrive=t,this},i.prototype._getLeave=function(){return this._getCommandInternal(this._onLeave,this.__commandsLeave)},i.prototype.setLeave=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this.__commandsLeave=t,this},i.prototype._getBye=function(){return this._getCommandInternal(this._onBye,this.__commandsBye)},i.prototype.setBye=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this.__commandsBye=t,this},i.prototype.getTitle=function(){return this._title},i.prototype.setTitle=function(e){return this._title=e},i.prototype._onInit=function(){},i.prototype._onHello=function(){},i.prototype._onArrive=function(){},i.prototype._onLeave=function(){},i.prototype._onBye=function(){},i}(jpp.event.EventDispatcher),jpp.util.Namespace("jpp.milkpack").register("Scene",t)}),jpp.util.Scope.temp(function(){var e;return jpp.util.Namespace("jpp.event").use(),e=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.INIT="init",t.CHANGE="change",t}(jpp.event.Event),jpp.util.Namespace("jpp.milkpack").register("MilkpackEvent",e)}),jpp.util.Scope.temp(function(){var t;return jpp.util.Namespace("jpp.util").use(),jpp.util.Namespace("jpp.event").use(),jpp.util.Namespace("jpp.milkpack").use(),t=function(t){function i(t){this._sceneChangeStatusHandler=r(this._sceneChangeStatusHandler,this),this._kazitoriExecutedHandler=r(this._kazitoriExecutedHandler,this),this._kazitoriRoutingNotFoundHandler=r(this._kazitoriRoutingNotFoundHandler,this),this._kazitoriRoutingHandler=r(this._kazitoriRoutingHandler,this);var n,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b=this;i.__super__.constructor.call(this,this),this._isReleaseMode=(p=t.isReleaseMode)!=null?p:!0,this._log=jpp.milkpack.Util.log,this._queue=[],this._queuePosition=-1,this._direction=[],this._targetFragment=null,this._targetScene=null,this._currentScene=null,this._notFoundScene=null,this._isInGeneratingSubFragment=!1,this._isRunning=!1,this._scenes={},this.root=(d=t.root)!=null?d:this.root,this.rootFile=(v=t.rootFile)!=null?v:this.rootFile,this.routes=(m=t.routes)!=null?m:this.routes,this.notFound=(g=t.notFound)!=null?g:this.notFound,u={},s=function(t,n){return function(){var r;return r=1<=arguments.length?e.call(arguments,0):[],b._kazitoriRoutingHandler(t,n,r)}},y=this.routes;for(a in y)f=y[a],u[a]=s(a,f);for(a in this.routes){n=jpp.milkpack.Util.decompseFragment(a).route;for(c=0,h=n.length;c<h;c++)l=n[c],u[l]===void 0&&(u[l]=s(l,null))}o={},o.root=this.root,o.rootFile=this.rootFile,o.routes=u,o.isAutoStart=!1,this._kazitori=new Kazitori(o),this._kazitori.addEventListener(KazitoriEvent.EXECUTED,this._kazitoriExecutedHandler),jpp.milkpack.Util.LOGGING=!0,jpp.milkpack.Util.printInit(i,this._kazitori,this.routes),this.onInit(),this._kazitori.start()}return n(i,t),i.VERSION="0.1.0",i.prototype.goto=function(e){return this._log("goto : '"+e+"'"),this._kazitori.change(e)},i.prototype.replace=function(e){return this._log("replace : '"+e+"'"),this._kazitori.replace(e)},i.prototype.next=function(){return this._log("next"),this._kazitori.torikazi()},i.prototype.prev=function(){return this._log("prev"),this._kazitori.omokazi()},i.prototype.getScene=function(e){var t,n;return this._log("get scene : '"+e+"'"),t=this._scenes[e],t===void 0&&(this._log("get scene temporary : '"+e+"'"),this._isInGeneratingSubFragment=!0,n=this._kazitori.fragment,this._kazitori.fragment=e,this._kazitori.executeHandlers(),this._kazitori.fragment=n,this._isInGeneratingSubFragment=!1,t=this._scenes[e]),t.getIsInitialized()===!1&&jpp.milkpack.Util.error("初期化されていないシーン'"+e+"'が呼び出されました"),t},i.prototype.onInit=function(){},i.prototype.onSceneRequest=function(e,t){return jpp.milkpack.Scene},i.prototype._kazitoriRoutingHandler=function(e,t,n){var r,i;r=this._kazitori.fragment,i=this._scenes[r];if(i===void 0){this._log("create new Scene of '"+r+"'");if(t===null){this._log("request Scene of '"+r+"'"),t=this.onSceneRequest(r,n);if(t===void 0||t===null)this._log("default Scene of '"+r+"'"),t=jpp.milkpack.Scene}i=new t(this,e,r,n),i.init(),this._scenes[r]=i}return this._log("kazitoriRoutingHandler : rule     = "+i.getRule()),this._log("kazitoriRoutingHandler : fragment = "+i.getFragment()),this._log("kazitoriRoutingHandler : params   = ["+i.getParams().join(", ")+"]")},i.prototype._kazitoriRoutingNotFoundHandler=function(e){this._log("404 :"+e.join(", "));if(this.notFound!==null)return this._notFoundScene===null&&(this._notFoundScene=new this.notFound(this,"",this._kazitori.fragment,e),this._notFoundScene.init()),this._pushRoute(this._kazitori.fragment)},i.prototype._kazitoriExecutedHandler=function(e){if(this._isInGeneratingSubFragment)return;return this._pushRoute(e.next)},i.prototype._pushRoute=function(e){var t,n,r,i;return this._targetFragment===null?n=jpp.milkpack.Util.decompseFragment(e):n=jpp.milkpack.Util.complementFragment(this._targetFragment,e),i=n.route,t=n.direction,i===null?!1:i.length===0?!1:i[i.length-1]===this._targetFragment?!1:(r=this._targetFragment,this._targetFragment=i[i.length-1],this._targetScene=this.getScene(this._targetFragment),this._queue=this._queue.slice(0,this._queuePosition).concat(i),this._direction=this._direction.slice(0,this._queuePosition).concat(t),this._log("pushRoute : queue = '"+this._queue.join("' -> '")+"'"),this._log("pushRoute : direction = '"+this._direction.join("' -> '")+"'"),this._log("pushRoute : position = "+this._queuePosition),document.getElementsByTagName("title")[0].firstChild.nodeValue=this._targetScene.getTitle(),this._log("change : route = '"+i.join("' -> '")+"'"),this.dispatchEvent(jpp.milkpack.MilkpackEvent.CHANGE,{prev:r,next:this._targetFragment}),this._startAsync(),!0)},i.prototype._startAsync=function(){return this._isRunning?!1:this._currentScene===null?(this._log("start async process : first"),this._nextAsync()):this._currentScene.getStatus()===jpp.milkpack.SceneStatus.STAY?(this._log("start async process : leave"),this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.leave()):this._getNextDirection()<0?(this._log("start async process : bye"),this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.bye()):(this._log("start async process : next"),this._nextAsync())},i.prototype._nextAsync=function(){var e,t,n;return this._log("next async process : first"),(n=this._currentScene)!=null&&n.removeEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),e=this._getNextDirection(),++this._queuePosition,t=this._queue[this._queuePosition],this._currentScene=this.getScene(t),e>=0?(this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.hello()):this._queuePosition===this._queue.length-1?(this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.arrive()):this._nextAsync()},i.prototype._sceneChangeStatusHandler=function(e){if(!e.extra.isComplete)return this._isRunning=!0;this._isRunning=!1,this._currentScene.removeEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler);switch(e.extra.status){case jpp.milkpack.SceneStatus.HELLO:return this._queuePosition===this._queue.length-1?(this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.arrive()):this._getNextDirection()>0?this._nextAsync():(this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.bye());case jpp.milkpack.SceneStatus.ARRIVE:if(this._queuePosition<this._queue.length-1)return this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.leave();break;case jpp.milkpack.SceneStatus.LEAVE:return this._getNextDirection()>0?this._nextAsync():(this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.bye());case jpp.milkpack.SceneStatus.BYE:return this._nextAsync()}},i.prototype._getNextDirection=function(){return this._queuePosition<0?1:this._queuePosition===this._queue.length-1?0:jpp.milkpack.Util.getDirection(this._queue[this._queuePosition],this._queue[this._queuePosition+1])},i}(jpp.event.EventDispatcher),jpp.util.Namespace("jpp.milkpack").register("Milkpack",t)})}).call(this);