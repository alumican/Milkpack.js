(function(){var __slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(t,e){function n(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},__bind=function(t,e){return function(){return t.apply(e,arguments)}};jpp.util.Scope.temp(function(){var t;return t=function(){function t(){}return t.LOGGING=!this._isReleaseMode,t.decompseFragment=function(t){var e,n,i,s,r,a,o;if(null===t||""===t||"/"===t)return{route:["/"],direction:!0};for(i=t.split("/"),e=[],s="",n=0,a=0,o=i.length;o>a;a++)r=i[a],s+="/"===s?r:"/"+r,i[n]=s,e[n]=!0,++n;return{route:i,direction:e}},t.complementFragment=function(e,n){var i,s,r,a,o,c,u,p,l;for(u=[],s=[],null==e&&(e=""),null==n&&(n=""),"/"===e.charAt(0)&&(e=e.substr(1)),"/"===n.charAt(0)&&(n=n.substr(1)),c=t.decompseFragment(e).route,o=t.decompseFragment(n).route,a=Math.min(c.length,o.length),i=0;a>i&&c[i]===o[i];)++i;for(i===o.length&&--i,a=i,r=c.length-1;r>=a;)u.push(c[r]),s.push(!1),--r;for(a=o.length-1,r=i;a>=r;)u.push(o[r]),s.push(!0),++r;for(r=p=l=u.length-1;1>=l?1>=p:p>=1;r=1>=l?++p:--p)u[r]===u[r-1]&&(u.splice(r,1),s.splice(r,1));return{route:u,direction:s}},t.getDirection=function(t,e){var n,i,s,r,a,o;if(t===e)return 0;for(n="/"===t?[""]:t.split("/"),s="/"===e?[""]:e.split("/"),i=n.length,r=s.length,o=Math.min(i,r),a=1;o>a&&n[a]===s[a];)++a;return i===r&&a===i-1?0:a===i&&r>a?1:-1},t.log=function(){var e;return e=arguments.length>=1?__slice.call(arguments,0):[],t.LOGGING?console.log("[Milkpack] "+e.join(" ")):void 0},t.error=function(){var t;return t=arguments.length>=1?__slice.call(arguments,0):[],console.log("[Milkpack Error] "+t.join(" "))},t.printInit=function(e,n,i){var s,r,a;if(t.LOGGING){a=[];for(s in i)r=i[s],a.push("           '"+s+"'");return t.log("----------------------------------------"),t.log("Milkpack "+e.VERSION+"  © Copyright alumican.net All rights reserved."),t.log("Kazitori "+n.VERSION+"  © Copyright hageee.net All rights reserved."),t.log("root: "+n.root),t.log("routes: \n"+a.join("\n")),t.log("----------------------------------------")}},t}(),jpp.util.Namespace("jpp.milkpack").register("Util",t)}),jpp.util.Scope.temp(function(){var t;return jpp.util.Namespace("jpp.event").use(),t=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.HELLO="hello",e.ARRIVE="arrive",e.STAY="stay",e.LEAVE="leave",e.BYE="bye",e.GONE="gone",e}(jpp.event.Event),jpp.util.Namespace("jpp.milkpack").register("SceneStatus",t)}),jpp.util.Scope.temp(function(){var t;return jpp.util.Namespace("jpp.event").use(),t=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.CHANGE_STATUS="chanegStatus",e}(jpp.event.Event),jpp.util.Namespace("jpp.milkpack").register("SceneEvent",t)}),jpp.util.Scope.temp(function(){var t;return jpp.util.Namespace("jpp.command").use(),jpp.util.Namespace("jpp.event").use(),jpp.util.Namespace("jpp.milkpack").use(),t=function(t){function e(t,n,i,s){this._onBye=__bind(this._onBye,this),this._onLeave=__bind(this._onLeave,this),this._onArrive=__bind(this._onArrive,this),this._onHello=__bind(this._onHello,this),this._onInit=__bind(this._onInit,this),this._getBye=__bind(this._getBye,this),this._getLeave=__bind(this._getLeave,this),this._getArrive=__bind(this._getArrive,this),this._getHello=__bind(this._getHello,this),this._commandCompleteHandler=__bind(this._commandCompleteHandler,this),e.__super__.constructor.call(this,this),this._manager=t,this._rule=n,this._fragment=i,this._params=s,this.self=this,this._title=null,this._status=jpp.milkpack.SceneStatus.GONE,this._isInitialized=!1,this._command=null,this._commandWrapper=null,this.__commandsHello=[],this.__commandsArrive=[],this.__commandsLeave=[],this.__commandsBye=[]}return __extends(e,t),e.self=null,e.prototype.init=function(){return this._isInitialized?void 0:(this._isInitialized=!0,this._onInit())},e.prototype.hello=function(){return this._switchStatus(jpp.milkpack.SceneStatus.HELLO,this._getHello)},e.prototype.arrive=function(){return this._switchStatus(jpp.milkpack.SceneStatus.ARRIVE,this._getArrive)},e.prototype.leave=function(){return this._switchStatus(jpp.milkpack.SceneStatus.LEAVE,this._getLeave)},e.prototype.bye=function(){return this._switchStatus(jpp.milkpack.SceneStatus.BYE,this._getBye)},e.prototype.addCommand=function(){var t,e;return t=arguments.length>=1?__slice.call(arguments,0):[],null!==this._commandWrapper?(e=this._commandWrapper).addCommand.apply(e,t):void 0},e.prototype.insertCommand=function(){var t,e;return t=arguments.length>=1?__slice.call(arguments,0):[],null!==this._commandWrapper?(e=this._commandWrapper).insertCommand.apply(e,t):void 0},e.prototype._switchStatus=function(t,e){return null!==this._command?(jpp.milkpack.Util.log("Command is being executed (status = "+this._status+")"),void 0):(this._clearCommand(),this._status=t,this._dispatchStatusEvent(this._status,!1),this._command=e(),this._command.addEventListener(jpp.event.Event.COMPLETE,this._commandCompleteHandler),this._command.execute())},e.prototype._clearCommand=function(){return null!==this._command?(this._command.removeEventListener(jpp.event.Event.COMPLETE,this._commandCompleteHandler),this._command.interrupt(),this._command=null):void 0},e.prototype._commandCompleteHandler=function(){var t;switch(this._clearCommand(),t=this._status,this._status){case jpp.milkpack.SceneStatus.ARRIVE:this._status=jpp.milkpack.SceneStatus.STAY;break;case jpp.milkpack.SceneStatus.BYE:this._status=jpp.milkpack.SceneStatus.GONE}return this._dispatchStatusEvent(t,!0)},e.prototype._dispatchStatusEvent=function(t,e){return jpp.milkpack.Util.log("Scene '"+this._fragment+"' : "+t+" "+(e?"End":"Begin")),this.dispatchEvent(jpp.milkpack.SceneEvent.CHANGE_STATUS,{status:t,isComplete:e})},e.prototype._getCommandInternal=function(t,e){return this._commandWrapper=new jpp.command.Serial,0===this.__commandsHello.length?t():this._commandWrapper.addCommandArray(e),this._commandWrapper},e.prototype.getIsInitialized=function(){return this._isInitialized},e.prototype.getManager=function(){return this._manager},e.prototype.getRule=function(){return this._rule},e.prototype.getFragment=function(){return this._fragment},e.prototype.getParams=function(){return this._params},e.prototype.getStatus=function(){return this._status},e.prototype._getHello=function(){return this._getCommandInternal(this._onHello,this.__commandsHello)},e.prototype.setHello=function(){var t;return t=arguments.length>=1?__slice.call(arguments,0):[],this.__commandsHello=t,this},e.prototype._getArrive=function(){return this._getCommandInternal(this._onArrive,this.__commandsArrive)},e.prototype.setArrive=function(){var t;return t=arguments.length>=1?__slice.call(arguments,0):[],this.__commandsArrive=t,this},e.prototype._getLeave=function(){return this._getCommandInternal(this._onLeave,this.__commandsLeave)},e.prototype.setLeave=function(){var t;return t=arguments.length>=1?__slice.call(arguments,0):[],this.__commandsLeave=t,this},e.prototype._getBye=function(){return this._getCommandInternal(this._onBye,this.__commandsBye)},e.prototype.setBye=function(){var t;return t=arguments.length>=1?__slice.call(arguments,0):[],this.__commandsBye=t,this},e.prototype.getTitle=function(){return this._title},e.prototype.setTitle=function(t){return this._title=t},e.prototype._onInit=function(){},e.prototype._onHello=function(){},e.prototype._onArrive=function(){},e.prototype._onLeave=function(){},e.prototype._onBye=function(){},e}(jpp.event.EventDispatcher),jpp.util.Namespace("jpp.milkpack").register("Scene",t)}),jpp.util.Scope.temp(function(){var t;return jpp.util.Namespace("jpp.event").use(),t=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.INIT="init",e.CHANGE="change",e}(jpp.event.Event),jpp.util.Namespace("jpp.milkpack").register("MilkpackEvent",t)}),jpp.util.Scope.temp(function(){var Milkpack;return jpp.util.Namespace("jpp.util").use(),jpp.util.Namespace("jpp.event").use(),jpp.util.Namespace("jpp.milkpack").use(),Milkpack=function(_super){function Milkpack(t){this._sceneChangeStatusHandler=__bind(this._sceneChangeStatusHandler,this),this._kazitoriExecutedHandler=__bind(this._kazitoriExecutedHandler,this),this._kazitoriRoutingNotFoundHandler=__bind(this._kazitoriRoutingNotFoundHandler,this),this._kazitoriRoutingHandler=__bind(this._kazitoriRoutingHandler,this);var e,n,i,s,r,a,o,c,u,p,l,_,h,m,g,d=this;Milkpack.__super__.constructor.call(this,this),this._isReleaseMode=null!=(p=t.isReleaseMode)?p:!0,this._log=jpp.milkpack.Util.log,this._queue=[],this._queuePosition=-1,this._direction=[],this._targetFragment=null,this._targetScene=null,this._currentScene=null,this._notFoundScene=null,this._isInGeneratingSubFragment=!1,this._isRunning=!1,this._scenes={},this.root=null!=(l=t.root)?l:this.root,this.rootFile=null!=(_=t.rootFile)?_:this.rootFile,this.routes=null!=(h=t.routes)?h:this.routes,this.notFound=null!=(m=t.notFound)?m:this.notFound,s={},n=function(t,e){return function(){var n;return n=arguments.length>=1?__slice.call(arguments,0):[],d._kazitoriRoutingHandler(t,e,n)}},g=this.routes;for(r in g)a=g[r],s[r]=n(r,a);for(r in this.routes)for(e=jpp.milkpack.Util.decompseFragment(r).route,c=0,u=e.length;u>c;c++)o=e[c],void 0===s[o]&&(s[o]=n(o,null));i={},i.root=this.root,i.rootFile=this.rootFile,i.routes=s,i.isAutoStart=!1,this._kazitori=new Kazitori(i),this._kazitori.addEventListener(KazitoriEvent.EXECUTED,this._kazitoriExecutedHandler),jpp.milkpack.Util.LOGGING=!0,jpp.milkpack.Util.printInit(Milkpack,this._kazitori,this.routes),this._initCommand=new jpp.command.Serial,this.onInit(),new jpp.command.Serial(this._initCommand,function(){return d._kazitori.start()}).execute()}return __extends(Milkpack,_super),Milkpack.VERSION="0.1.0",Milkpack.prototype.goto=function(t){return this._log("goto : '"+t+"'"),this._kazitori.change(t)},Milkpack.prototype.replace=function(t){return this._log("replace : '"+t+"'"),this._kazitori.replace(t)},Milkpack.prototype.next=function(){return this._log("next"),this._kazitori.torikazi()},Milkpack.prototype.prev=function(){return this._log("prev"),this._kazitori.omokazi()},Milkpack.prototype.getScene=function(t){var e,n;return this._log("get scene : '"+t+"'"),e=this._scenes[t],void 0===e&&(this._log("get scene temporary : '"+t+"'"),this._isInGeneratingSubFragment=!0,n=this._kazitori.fragment,this._kazitori.fragment=t,this._kazitori.executeHandlers(),this._kazitori.fragment=n,this._isInGeneratingSubFragment=!1,e=this._scenes[t]),e.getIsInitialized()===!1&&jpp.milkpack.Util.error("初期化されていないシーン'"+t+"'が呼び出されました"),e},Milkpack.prototype.onInit=function(){},Milkpack.prototype.onSceneRequest=function(){return jpp.milkpack.Scene},Milkpack.prototype.addCommand=function(){var t,e;return t=arguments.length>=1?__slice.call(arguments,0):[],null!==this._initCommand?(e=this._initCommand).addCommand.apply(e,t):void 0},Milkpack.prototype.insertCommand=function(){var t,e;return t=arguments.length>=1?__slice.call(arguments,0):[],null!==this._initCommand?(e=this._initCommand).insertCommand.apply(e,t):void 0},Milkpack.prototype.getTargetFragment=function(){return this._kazitori.fragment},Milkpack.prototype.getTargetScene=function(){return this._taregtScene},Milkpack.prototype._kazitoriRoutingHandler=function(rule,sceneClass,params){var fragment,scene;return fragment=this._kazitori.fragment,scene=this._scenes[fragment],void 0===scene&&(this._log("create new Scene of '"+fragment+"'"),"string"==typeof sceneClass&&(sceneClass=eval(sceneClass)),null===sceneClass&&(this._log("request Scene of '"+fragment+"'"),sceneClass=this.onSceneRequest(fragment,params),(void 0===sceneClass||null===sceneClass)&&(this._log("default Scene of '"+fragment+"'"),sceneClass=jpp.milkpack.Scene)),scene=new sceneClass(this,rule,fragment,params),scene.init(),this._scenes[fragment]=scene),this._log("kazitoriRoutingHandler : rule     = "+scene.getRule()),this._log("kazitoriRoutingHandler : fragment = "+scene.getFragment()),this._log("kazitoriRoutingHandler : params   = ["+scene.getParams().join(", ")+"]")},Milkpack.prototype._kazitoriRoutingNotFoundHandler=function(t){return this._log("404 :"+t.join(", ")),null!==this.notFound?(null===this._notFoundScene&&(this._notFoundScene=new this.notFound(this,"",this._kazitori.fragment,t),this._notFoundScene.init()),this._pushRoute(this._kazitori.fragment)):void 0},Milkpack.prototype._kazitoriExecutedHandler=function(t){return this._log("kazitoriExecutedHandler : isInGeneratingSubFragment = "+this._isInGeneratingSubFragment),this._log("kazitoriExecutedHandler : next                      = "+t.next),this._isInGeneratingSubFragment?void 0:this._pushRoute(t.next)},Milkpack.prototype._pushRoute=function(t){var e,n,i,s;return n=null===this._targetFragment?jpp.milkpack.Util.decompseFragment(t):jpp.milkpack.Util.complementFragment(this._targetFragment,t),s=n.route,e=n.direction,null===s?!1:0===s.length?!1:s[s.length-1]===this._targetFragment?!1:(i=this._targetFragment,this._targetFragment=s[s.length-1],this._targetScene=this.getScene(this._targetFragment),this._queue.length>0&&this._queue[this._queue.length-1]===s[0]?(this._queue=this._queue.slice(0,this._queuePosition).concat(s),this._direction=this._direction.slice(0,this._queuePosition).concat(e)):(this._queue=this._queue.slice(0,+this._queuePosition+1||9e9).concat(s),this._direction=this._direction.slice(0,+this._queuePosition+1||9e9).concat(e)),this._log("pushRoute : queue = '"+this._queue.join("' -> '")+"'"),this._log("pushRoute : direction = '"+this._direction.join("' -> '")+"'"),this._log("pushRoute : position = "+this._queuePosition),document.getElementsByTagName("title")[0].firstChild.nodeValue=this._targetScene.getTitle(),this._log("change : route = '"+s.join("' -> '")+"'"),this.dispatchEvent(jpp.milkpack.MilkpackEvent.CHANGE,{prev:i,next:this._targetFragment}),this._startAsync(),!0)},Milkpack.prototype._startAsync=function(){return this._isRunning?!1:null===this._currentScene?(this._log("start async process : first"),this._nextAsync()):this._currentScene.getStatus()===jpp.milkpack.SceneStatus.STAY?(this._log("start async process : leave"),this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.leave()):0>this._getNextDirection()?(this._log("start async process : bye"),this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.bye()):(this._log("start async process : next"),this._nextAsync())},Milkpack.prototype._nextAsync=function(){var t,e,n;return this._log("next async process : first"),null!=(n=this._currentScene)&&n.removeEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),t=this._getNextDirection(),++this._queuePosition,e=this._queue[this._queuePosition],this._currentScene=this.getScene(e),0>t&&e!==this._targetFragment?(this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.bye()):t>=0?(this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.hello()):this._queuePosition===this._queue.length-1?(this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.arrive()):this._nextAsync()},Milkpack.prototype._sceneChangeStatusHandler=function(t){if(!t.extra.isComplete)return this._isRunning=!0;switch(this._isRunning=!1,this._currentScene.removeEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),t.extra.status){case jpp.milkpack.SceneStatus.HELLO:return this._queuePosition===this._queue.length-1?(this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.arrive()):this._getNextDirection()>0?this._nextAsync():(this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.bye());case jpp.milkpack.SceneStatus.ARRIVE:if(this._queuePosition<this._queue.length-1)return this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.leave();break;case jpp.milkpack.SceneStatus.LEAVE:return this._getNextDirection()>0?this._nextAsync():(this._currentScene.addEventListener(jpp.milkpack.SceneEvent.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.bye());case jpp.milkpack.SceneStatus.BYE:return this._nextAsync()}},Milkpack.prototype._getNextDirection=function(){return 0>this._queuePosition?1:this._queuePosition===this._queue.length-1?0:jpp.milkpack.Util.getDirection(this._queue[this._queuePosition],this._queue[this._queuePosition+1])},Milkpack}(jpp.event.EventDispatcher),jpp.util.Namespace("jpp.milkpack").register("Milkpack",Milkpack)})}).call(this);
