(function(){var e,t,n,r,i,s,o=function(e,t){return function(){return e.apply(t,arguments)}},u={}.hasOwnProperty,a=function(e,t){function r(){this.constructor=e}for(var n in t)u.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},f=[].slice;e=function(e){function u(e){this._sceneChangeStatusHandler=o(this._sceneChangeStatusHandler,this),this._kazitoriExecutedHandler=o(this._kazitoriExecutedHandler,this),this._kazitoriRoutingNotFoundHandler=o(this._kazitoriRoutingNotFoundHandler,this),this._kazitoriRoutingHandler=o(this._kazitoriRoutingHandler,this);var t,n,r,i,a,l,c,h,p,d,v,m,g,y,b=this;u.__super__.constructor.call(this,this),this._isReleaseMode=(d=e.isReleaseMode)!=null?d:!0,this._log=s.log,this._queue=[],this._queuePosition=-1,this._direction=[],this._targetFragment=null,this._currentScene=null,this._isInGeneratingSubFragment=!1,this._isRunning=!1,this._isFirstRequest=!0,this._scenes={},this.root=(v=e.root)!=null?v:this.root,this.rootFile=(m=e.rootFile)!=null?m:this.rootFile,this.routes=(g=e.routes)!=null?g:this.routes,i={},n=function(e,t){return function(){var n;return n=1<=arguments.length?f.call(arguments,0):[],b._kazitoriRoutingHandler(e,t,n)}},y=this.routes;for(a in y)l=y[a],i[a]=n(a,l);for(a in this.routes){t=s.decompseFragment(a).route;for(h=0,p=t.length;h<p;h++)c=t[h],i[c]===void 0&&(i[c]=n(c,null))}r={},r.root=this.root,r.rootFile=this.rootFile,r.routes=i,r.isAutoStart=!1,r.notFound=function(){var e;return e=1<=arguments.length?f.call(arguments,0):[],b._kazitoriRoutingNotFoundHandler(e)},this._kazitori=new Kazitori(r),this._kazitori.addEventListener(KazitoriEvent.EXECUTED,this._kazitoriExecutedHandler),s.LOGGING=!0,s.printInit(this._kazitori,this.routes),this.onInit(),this._kazitori.start()}return a(u,e),u.VERSION="0.1.0",u.prototype.goto=function(e){return this._log("goto : '"+e+"'"),this._kazitori.change(e)},u.prototype.next=function(){return this._log("next"),this._kazitori.torikazi()},u.prototype.prev=function(){return this._log("prev"),this._kazitori.omokazi()},u.prototype.getScene=function(e){var t,n;return this._log("get scene : '"+e+"'"),t=this._scenes[e],t===void 0&&(this._log("get scene temporary : '"+e+"'"),this._isInGeneratingSubFragment=!0,n=this._kazitori.fragment,this._kazitori.fragment=e,this._kazitori.executeHandlers(),this._kazitori.fragment=n,this._isInGeneratingSubFragment=!1,t=this._scenes[e]),t.getIsInitialized()===!1&&s.error("初期化されていないシーン'"+e+"'が呼び出されました"),t},u.prototype.onInit=function(){},u.prototype.onSceneRequest=function(e,t){return n},u.prototype._kazitoriRoutingHandler=function(e,t,r){var i,s;i=this._kazitori.fragment,s=this._scenes[i];if(s===void 0){this._log("create new Scene of '"+i+"'");if(t===null){this._log("request Scene of '"+i+"'"),t=this.onSceneRequest(i,r);if(t===void 0||t===null)this._log("default Scene of '"+i+"'"),t=n}s=new t(this,e,i,r),s.init(),this._scenes[i]=s}return this._log("kazitoriRoutingHandler : rule     = "+s.getRule()),this._log("kazitoriRoutingHandler : fragment = "+s.getFragment()),this._log("kazitoriRoutingHandler : params   = ["+s.getParams().join(", ")+"]")},u.prototype._kazitoriRoutingNotFoundHandler=function(e){return this._log("404 :"+e.join(", "))},u.prototype._kazitoriExecutedHandler=function(e){var t,n,r,i;if(this._isInGeneratingSubFragment)return;if(this._isFirstRequest&&e.next===this.root)return;return this._isFirstRequest=!1,r=e.next,this._targetFragment===null?n=s.decompseFragment(r):n=s.complementFragment(this._targetFragment,r),i=n.route,t=n.direction,this._pushRoute(i,t)},u.prototype._pushRoute=function(e,n){var r;return e===null?!1:e.length===0?!1:e[e.length-1]===this._targetFragment?!1:(r=this._targetFragment,this._targetFragment=e[e.length-1],this._queue=this._queue.slice(0,this._queuePosition).concat(e),this._direction=this._direction.slice(0,this._queuePosition).concat(n),this._log("pushRoute : queue = '"+this._queue.join("' -> '")+"'"),this._log("pushRoute : direction = '"+this._direction.join("' -> '")+"'"),this._log("pushRoute : position = "+this._queuePosition),this._log("change : route = '"+e.join("' -> '")+"'"),this.dispatchEvent(t.CHANGE,{prev:r,next:this._targetFragment}),this._startAsync(),!0)},u.prototype._startAsync=function(){return this._isRunning?!1:this._currentScene===null?(this._log("start async process : first"),this._nextAsync()):this._currentScene.getStatus()===i.STAY?(this._log("start async process : leave"),this._currentScene.addEventListener(r.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.leave()):this._getNextDirection()<0?(this._log("start async process : bye"),this._currentScene.addEventListener(r.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.bye()):(this._log("start async process : next"),this._nextAsync())},u.prototype._nextAsync=function(){var e,t,n;return this._log("next async process : first"),(n=this._currentScene)!=null&&n.removeEventListener(r.CHANGE_STATUS,this._sceneChangeStatusHandler),e=this._getNextDirection(),++this._queuePosition,t=this._queue[this._queuePosition],this._currentScene=this.getScene(t),e>=0?(this._currentScene.addEventListener(r.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.hello()):this._queuePosition===this._queue.length-1?(this._currentScene.addEventListener(r.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.arrive()):this._nextAsync()},u.prototype._sceneChangeStatusHandler=function(e){if(!e.extra.isComplete)return this._isRunning=!0;this._isRunning=!1,this._currentScene.removeEventListener(r.CHANGE_STATUS,this._sceneChangeStatusHandler);switch(e.extra.status){case i.HELLO:return this._queuePosition===this._queue.length-1?(this._currentScene.addEventListener(r.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.arrive()):this._getNextDirection()>0?this._nextAsync():(this._currentScene.addEventListener(r.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.bye());case i.ARRIVE:if(this._queuePosition<this._queue.length-1)return this._currentScene.addEventListener(r.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.leave();break;case i.LEAVE:return this._getNextDirection()>0?this._nextAsync():(this._currentScene.addEventListener(r.CHANGE_STATUS,this._sceneChangeStatusHandler),this._currentScene.bye());case i.BYE:return this._nextAsync()}},u.prototype._getNextDirection=function(){return this._queuePosition<0?1:this._queuePosition===this._queue.length-1?0:s.getDirection(this._queue[this._queuePosition],this._queue[this._queuePosition+1])},u}(EventDispatcher),Namespace("jpp.milkpack").register("Milkpack",e),t=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return a(t,e),t.INIT="init",t.CHANGE="change",t}(Event),Namespace("jpp.milkpack").register("MilkpackEvent",t),n=function(e){function t(e,n,r,s){this._onBye=o(this._onBye,this),this._onLeave=o(this._onLeave,this),this._onArrive=o(this._onArrive,this),this._onHello=o(this._onHello,this),this._onInit=o(this._onInit,this),this._getBye=o(this._getBye,this),this._getLeave=o(this._getLeave,this),this._getArrive=o(this._getArrive,this),this._getHello=o(this._getHello,this),this._commandCompleteHandler=o(this._commandCompleteHandler,this),t.__super__.constructor.call(this,this),this._manager=e,this._rule=n,this._fragment=r,this._params=s,this.self=this,this._title=null,this._status=i.GONE,this._isInitialized=!1,this._command=null,this._commandWrapper=null,this.__commandsHello=[],this.__commandsArrive=[],this.__commandsLeave=[],this.__commandsBye=[]}return a(t,e),t.self=null,t.prototype.init=function(){if(this._isInitialized)return;return this._isInitialized=!0,this._onInit()},t.prototype.hello=function(){return this._switchStatus(i.HELLO,this._getHello)},t.prototype.arrive=function(){return this._switchStatus(i.ARRIVE,this._getArrive)},t.prototype.leave=function(){return this._switchStatus(i.LEAVE,this._getLeave)},t.prototype.bye=function(){return this._switchStatus(i.BYE,this._getBye)},t.prototype.addCommand=function(){var e,t;e=1<=arguments.length?f.call(arguments,0):[];if(this._commandWrapper!==null)return(t=this._commandWrapper).addCommand.apply(t,e)},t.prototype.insertCommand=function(){var e,t;e=1<=arguments.length?f.call(arguments,0):[];if(this._commandWrapper!==null)return(t=this._commandWrapper).insertCommand.apply(t,e)},t.prototype._switchStatus=function(e,t){if(this._command!==null){s.log("Command is being executed (status = "+this._status+")");return}return this._clearCommand(),this._status=e,this._dispatchStatusEvent(this._status,!1),this._command=t(),this._command.addEventListener(Event.COMPLETE,this._commandCompleteHandler),this._command.execute()},t.prototype._clearCommand=function(){if(this._command!==null)return this._command.removeEventListener(Event.COMPLETE,this._commandCompleteHandler),this._command.interrupt(),this._command=null},t.prototype._commandCompleteHandler=function(e){var t;this._clearCommand(),t=this._status;switch(this._status){case i.ARRIVE:this._status=i.STAY;break;case i.BYE:this._status=i.GONE}return this._dispatchStatusEvent(t,!0)},t.prototype._dispatchStatusEvent=function(e,t){return s.log("Scene '"+this._fragment+"' : "+e+" "+(t?"End":"Begin")),this.dispatchEvent(r.CHANGE_STATUS,{status:e,isComplete:t})},t.prototype._getCommandInternal=function(e,t){return this._commandWrapper=new Serial,this.__commandsHello.length===0?e():this._commandWrapper.addCommandArray(t),this._commandWrapper},t.prototype.getIsInitialized=function(){return this._isInitialized},t.prototype.getManager=function(){return this._manager},t.prototype.getRule=function(){return this._rule},t.prototype.getFragment=function(){return this._fragment},t.prototype.getParams=function(){return this._params},t.prototype.getStatus=function(){return this._status},t.prototype._getHello=function(){return this._getCommandInternal(this._onHello,this.__commandsHello)},t.prototype.setHello=function(){var e;return e=1<=arguments.length?f.call(arguments,0):[],this.__commandsHello=e,this},t.prototype._getArrive=function(){return this._getCommandInternal(this._onArrive,this.__commandsArrive)},t.prototype.setArrive=function(){var e;return e=1<=arguments.length?f.call(arguments,0):[],this.__commandsArrive=e,this},t.prototype._getLeave=function(){return this._getCommandInternal(this._onLeave,this.__commandsLeave)},t.prototype.setLeave=function(){var e;return e=1<=arguments.length?f.call(arguments,0):[],this.__commandsLeave=e,this},t.prototype._getBye=function(){return this._getCommandInternal(this._onBye,this.__commandsBye)},t.prototype.setBye=function(){var e;return e=1<=arguments.length?f.call(arguments,0):[],this.__commandsBye=e,this},t.prototype.getTitle=function(){return this._title},t.prototype.setTitle=function(e){return this._title=e},t.prototype._onInit=function(){},t.prototype._onHello=function(){},t.prototype._onArrive=function(){},t.prototype._onLeave=function(){},t.prototype._onBye=function(){},t}(EventDispatcher),Namespace("jpp.milkpack").register("Scene",n),r=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return a(t,e),t.CHANGE_STATUS="chanegStatus",t}(Event),Namespace("jpp.milkpack").register("SceneEvent",r),i=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return a(t,e),t.HELLO="hello",t.ARRIVE="arrive",t.STAY="stay",t.LEAVE="leave",t.BYE="bye",t.GONE="gone",t}(Event),Namespace("jpp.milkpack").register("SceneStatus",i),s=function(){function t(){}return t.LOGGING=!0,t.decompseFragment=function(e){var t,n,r,i,s,o,u;if(e===null||e===""||e==="/")return{route:["/"],direction:!0};r=e.split("/"),t=[],i="",n=0;for(o=0,u=r.length;o<u;o++)s=r[o],i+=i==="/"?s:"/"+s,r[n]=i,t[n]=!0,++n;return{route:r,direction:t}},t.complementFragment=function(e,n){var r,i,s,o,u,a,f;f=[],i=[],e==null&&(e=""),n==null&&(n=""),e.charAt(0)==="/"&&(e=e.substr(1)),n.charAt(0)==="/"&&(n=n.substr(1)),a=t.decompseFragment(e).route,u=t.decompseFragment(n).route,o=Math.min(a.length,u.length),r=0;while(r<o){if(a[r]!==u[r])break;++r}o=r,s=a.length-1;while(s>=o)f.push(a[s]),i.push(!1),--s;o=u.length-1,s=r;while(s<=o)f.push(u[s]),i.push(!0),++s;return{route:f,direction:i}},t.getDirection=function(e,t){var n,r,i,s,o,u;if(e===t)return 0;n=e==="/"?[""]:e.split("/"),i=t==="/"?[""]:t.split("/"),r=n.length,s=i.length,u=Math.min(r,s),o=1;while(o<u){if(n[o]!==i[o])break;++o}return r===s&&o===r-1?0:o===r&&o<s?1:-1},t.log=function(){var e;e=1<=arguments.length?f.call(arguments,0):[];if(t.LOGGING)return console.log("[Comppass] "+e.join(" "))},t.error=function(){var e;return e=1<=arguments.length?f.call(arguments,0):[],console.log("[Comppass Error] "+e.join(" "))},t.printInit=function(n,r){var i,s,o;if(!t.LOGGING)return;o=[];for(i in r)s=r[i],o.push("           '"+i+"'");return t.log("----------------------------------------"),t.log("Milkpack "+e.VERSION+"  © Copyright alumican.net All rights reserved."),t.log("Kazitori "+n.VERSION+"  © Copyright hageee.net All rights reserved."),t.log("root: "+n.root),t.log("routes: \n"+o.join("\n")),t.log("----------------------------------------")},t}(),Namespace("jpp.milkpack").register("Util",s)}).call(this);